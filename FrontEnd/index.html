<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4); }
        .sidebar { background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); height: 100vh; position: fixed; width: 250px; z-index: 1000; }
        .nav-link { color: white !important; }
        .nav-link:hover, .nav-link.active { background: rgba(255, 255, 255, 0.2); }
        .main-content { margin-left: 250px; padding: 2rem; }
        .page { display: none; }
        .page.active { display: block; }
        .welcome-card, .form-add, .table-container { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .mac-col { font-family: monospace; font-weight: bold; color: #667eea; }
        .login-container { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); padding: 2rem; width: 100%; max-width: 400px; }
        .wifi-icon { font-size: 3rem; color: #667eea; text-align: center; margin-bottom: 1rem; }
        @media (max-width: 768px) { .sidebar { width: 100%; height: auto; position: relative; } .main-content { margin-left: 0; }.table-scroll-wrapper {max-height: 400px;} }
       
        #toastContainer {position: fixed;bottom: 20px;right: 20px;z-index: 9999;}
        .toast-item {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 10px;
            animation: fadeInOut 3s forwards;
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        @keyframes fadeInOut {0%, 100% { opacity: 0; transform: translateY(20px); }15%, 85% { opacity: 1; transform: translateY(0); }}
        /* Toggle */
        .status-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .status-toggle input {opacity: 0;width: 0;height: 0;}
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .slider {background-color: #28a745;}
        input:checked + .slider:before {transform: translateX(20px);}
        /* Thanh cuộn */
        .table-scroll-wrapper {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-top: 10px;
        }
        .table-scroll-wrapper::-webkit-scrollbar {width: 8px;height: 8px;}
        .table-scroll-wrapper::-webkit-scrollbar-track {background: #f1f1f1; border-radius: 10px;}
        .table-scroll-wrapper::-webkit-scrollbar-thumb {background: #c0c0c0;border-radius: 10px;}
        .table-scroll-wrapper::-webkit-scrollbar-thumb:hover {background: #a8a8a8;}
        .table-scroll-wrapper table {margin-bottom: 0;}
        .table-scroll-wrapper thead th {
            position: sticky;
            top: 0;
            background: #667eea !important;
            color: white !important;
            z-index: 10;
            box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Modal Sửa Điểm Danh (ĐÃ DI CHUYỂN VÀO TRONG BODY) -->
    <div class="modal fade" id="editDiemDanhModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Sửa Điểm Danh</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editDiemDanhForm">
              <input type="hidden" id="editDdId">
              <div class="mb-3">
                <label class="form-label">Tên SV</label>
                <input type="text" class="form-control" id="editTenSV" disabled>
              </div>
              <div class="mb-3">
                <label class="form-label">Giờ vào (HH:MM)</label>
                <input type="text" class="form-control" id="editTDVao" placeholder="09:15" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Giờ ra (HH:MM)</label>
                <input type="text" class="form-control" id="editTDRa" placeholder="Chưa ra">
              </div>
              <div id="editDdMessage"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
            <button type="button" class="btn btn-primary" onclick="saveEditDiemDanh()">Lưu</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Trang đăng nhập -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-card">
                <div class="wifi-icon">WiFi</div>
                <h2 class="text-center mb-4">WiFi Attendance</h2>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Tên đăng nhập</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Mật khẩu</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Đăng Nhập</button>
                </form>
                <div id="loginMessage" class="mt-3 text-center"></div>
            </div>
        </div>
    </div>
    <!-- Nội dung chính -->
    <div id="mainApp" style="display: none;">
        <div class="sidebar">
            <div class="p-3 text-white"><h4>WiFi Attendance</h4></div>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" href="#" onclick="showPage('dashboard')">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('sinhvien')">Danh sách Sinh viên</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('thietbi')">Danh sách Thiết bị</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('diemdanh')">Điểm danh</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('caidat')">Cài đặt</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Đăng xuất</a></li>
            </ul>
        </div>
        <!-- Dashboard -->
        <div id="dashboardPage" class="page">
            <div class="main-content">
                <div class="welcome-card">
                    <h2>Chào mừng đến với Hệ thống Điểm danh WiFi</h2>
                    <p>Quản lý điểm danh sinh viên qua kết nối WiFi một cách tự động và chính xác.</p>
                    <div class="row mt-4" id="statsRow">
                        <div class="col-md-3"><div class="card text-center p-3"><h5 id="svCount">0</h5><p>Sinh viên</p></div></div>
                        <div class="col-md-3"><div class="card text-center p-3"><h5 id="tbCount">0</h5><p>Thiết bị</p></div></div>
                        <div class="col-md-3"><div class="card text-center p-3"><h5 id="attendanceRate">0%</h5><p>Tỷ lệ Có mặt</p></div></div>
                        <div class="col-md-3"><div class="card text-center p-3"><h5 id="currentSession">Sáng</h5><p>Buổi Hiện tại</p></div></div>
                    </div>
                    <div id="scanStatus" class="mt-3 alert alert-info" style="display: none;">Quét WiFi đang hoạt động...</div>
                </div>
            </div>
        </div>
        <!-- Sinh viên -->
        <div id="sinhvienPage" class="page">
            <div class="main-content">
                <h2>Danh sách Sinh viên</h2>
                <div class="form-add">
                    <h5>Thêm/Sửa Sinh viên</h5>
                    <form id="addSinhVienForm">
                        <input type="hidden" id="editSvId">
                        <div class="row">
                            <div class="col-md-6 mb-3"><label>Tên</label><input type="text" class="form-control" id="tenSV" required></div>
                            <div class="col-md-6 mb-3"><label>MSSV</label><input type="text" class="form-control" id="mssvSV" required></div>
                        </div>
                        <button type="submit" class="btn btn-success">Thêm</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetSvForm()">Hủy</button>
                    </form>
                </div>
                <div class="table-container">
                    <div class="table-scroll-wrapper">
                        <table class="table table-striped table-hover" id="sinhVienTable">
                            <thead class="table-dark"><tr><th>ID</th><th>Tên</th><th>MSSV</th><th>Trạng thái</th><th>Hành động</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Toast nhẹ -->
        <div id="toastContainer"></div>
        <!-- Thiết bị -->
        <div id="thietbiPage" class="page">
            <div class="main-content">
                <h2>Danh sách Thiết bị</h2>
                <div class="form-add">
                    <h5>Thêm/Sửa Thiết bị</h5>
                    <form id="addThietBiForm">
                        <input type="hidden" id="editTbId">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label>Sinh viên</label>
                                <select class="form-control" id="svIdTB" required>
                                    <option value="">-- Chọn Sinh viên --</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label>MAC</label>
                                <input type="text" class="form-control" id="macTB" required placeholder="AA:BB:CC:DD:EE:FF">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label>Tên Thiết bị</label>
                                <input type="text" class="form-control" id="tenTB" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Thêm</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetTbForm()">Hủy</button>
                    </form>
                </div>
                <div class="table-container">
                    <div class="table-scroll-wrapper">
                        <table class="table table-striped table-hover" id="thietBiTable">
                            <thead class="table-dark">
                                <tr><th>ID</th><th>Sinh viên</th><th>MAC</th><th>Tên TB</th><th>Thời gian</th><th>Trạng thái</th><th>Hành động</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Điểm danh -->
        <div id="diemdanhPage" class="page">
            <div class="main-content">
                <h2>Điểm danh</h2>
                <div class="form-add">
                    <h5>Điểm danh Thủ công</h5>
                    <p class="text-muted small">Chọn sinh viên → MAC tự động → Ghi nhận điểm danh.</p>
                    <form id="diemDanhForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Chọn Sinh viên</label>
                                <select class="form-control" id="svSelectDD" required>
                                    <option value="">-- Chọn Sinh viên --</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>MAC (Tự động)</label>
                                <input type="text" class="form-control" id="macDD" readonly>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Ghi nhận Điểm danh</button>
                        <button type="button" class="btn btn-success ms-3" onclick="exportToExcel()">Xuất File Danh Sách</button>
                    </form>
                    <div id="ddMessage" class="mt-2"></div>
                </div>
                <div class="filter-container mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <label>Lọc theo ngày</label>
                            <input type="date" class="form-control" id="filterNgay">
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-scroll-wrapper">
                        <table class="table table-striped table-hover" id="diemDanhTable">
                            <thead class="table-dark">
                                <tr><th>Tên SV</th><th>MAC</th><th>Buổi</th><th>Vào</th><th>Ra</th><th>Ngày</th><th>Trạng thái</th><th>Hành động</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Cài đặt -->
        <div id="caidatPage" class="page">
            <div class="main-content">
                <h2>Cài đặt Buổi Học</h2>
                <div class="form-add">
                    <h5>Thêm/Sửa Cài đặt</h5>
                    <form id="addCaiDatForm">
                        <input type="hidden" id="editCdId">
                        <div class="row">
                            <div class="col-md-3 mb-3"><label>Buổi</label>
                                <select class="form-control" id="buoiCD" required>
                                    <option value="">Chọn buổi</option>
                                    <option value="Sáng">Sáng</option>
                                    <option value="Chiều">Chiều</option>
                                    <option value="Tối">Tối</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3"><label>Bắt đầu</label><input type="time" class="form-control" id="tdBatDau" required></div>
                            <div class="col-md-3 mb-3"><label>Kết thúc</label><input type="time" class="form-control" id="tdKetThuc" required></div>
                            <div class="col-md-3 mb-3"><label>Reset</label><input type="time" class="form-control" id="tdReset"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label>Email</label><input type="email" class="form-control" id="mailCD"></div>
                            <div class="col-md-6 mb-3"><label>Đi trễ (phút)</label><input type="number" class="form-control" id="tgDiTre" min="0" value="0"></div>
                        </div>
                        <button type="submit" class="btn btn-success">Thêm</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetCdForm()">Hủy</button>
                    </form>
                </div>
                <div class="table-container">
                    <div class="table-scroll-wrapper">
                        <table class="table table-striped table-hover" id="caiDatTable">
                            <thead class="table-dark">
                                <tr><th>ID</th><th>Buổi</th><th>Bắt đầu</th><th>Kết thúc</th><th>Reset</th><th>Email</th><th>Đi trễ</th><th>Thời gian</th><th>TT</th><th>Hành động</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========== TOÀN CỤC ==========
        let mapSinhVienToMac = {};
        let editModal; // Khởi tạo biến global cho modal
        // ========== SHOW PAGE ==========
        window.showPage = function(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const page = document.getElementById(pageName + 'Page');
            if (page) page.classList.add('active');
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('active');
                if (l.getAttribute('onclick')?.includes(pageName)) l.classList.add('active');
            });
            if (pageName === 'dashboard') loadDashboardStats();
            else if (pageName === 'sinhvien') loadSinhVien();
            else if (pageName === 'thietbi') { loadThietBi(); loadSinhVienForDropdown(); }
            else if (pageName === 'diemdanh') { loadDiemDanh(); loadSinhVienForDiemDanh(); }
            else if (pageName === 'caidat') loadCaiDat();
        };
        // ========== ĐĂNG NHẬP ==========
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');
            try {
                const response = await fetch('http://localhost:5000/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (response.ok) {
                    messageDiv.innerHTML = '<div class="alert alert-success">Đăng nhập thành công!</div>';
                    localStorage.setItem('loggedIn', 'true');
                    setTimeout(() => {
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        showPage('dashboard');
                    }, 1000);
                } else {
                    messageDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="alert alert-danger">Lỗi kết nối backend!</div>';
            }
        });
        function logout() {
            localStorage.removeItem('loggedIn');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('loginPage').classList.add('active');
            document.getElementById('loginForm').reset();
        }
        // ========== TOAST ==========
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast-item';
            toast.style.background = type === 'danger' ? 'rgba(220,53,69,0.9)' :
                                    type === 'warning' ? 'rgba(255,193,7,0.9)' : 'rgba(40,167,69,0.9)';
            toast.innerHTML = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        // ========== DASHBOARD ==========
        async function loadDashboardStats() {
            try {
                const [svRes, tbRes, ddRes] = await Promise.all([
                    fetch('http://localhost:5000/sinhvien'),
                    fetch('http://localhost:5000/thietbi'),
                    fetch('http://localhost:5000/diemdanh')
                ]);
                const sv = await svRes.json();
                const tb = await tbRes.json();
                const dd = await ddRes.json();
                document.getElementById('svCount').textContent = sv.length;
                document.getElementById('tbCount').textContent = tb.length;
                const today = new Date().toISOString().split('T')[0];
                const todayDD = dd.filter(d => d.Ngay === today || (d.TD_Vao && new Date(d.TD_Vao).toISOString().split('T')[0] === today));
                const coMat = todayDD.filter(d => d.TrangThai && d.TrangThai.includes('Có mặt')).length;
                const rate = todayDD.length > 0 ? Math.round((coMat / todayDD.length) * 100) : 0;
                document.getElementById('attendanceRate').textContent = rate + '%';
                const hour = new Date().getHours();
                document.getElementById('currentSession').textContent = hour < 12 ? 'Sáng' : hour < 17 ? 'Chiều' : 'Tối';
                document.getElementById('scanStatus').style.display = 'block';
            } catch (err) { console.error(err); }
        }
        // ========== SINH VIÊN ==========
        async function loadSinhVien() {
            try {
                const res = await fetch('http://localhost:5000/sinhvien');
                const data = await res.json();
                const tbody = document.querySelector('#sinhVienTable tbody');
                tbody.innerHTML = '';
                data.forEach(sv => {
                    const isActive = sv.Is_active === true;
                    tbody.innerHTML += `<tr>
                        <td><small class="text-muted">${sv._id.slice(-6)}</small></td>
                        <td><strong>${sv.Ten}</strong></td>
                        <td>${sv.MSSV}</td>
                        <td>
                            <label class="status-toggle">
                                <input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleSvStatus('${sv._id}', this.checked)">
                                <span class="slider"></span>
                            </label>
                            <span style="margin-left:8px; font-weight:500; color:${isActive ? '#28a745' : '#dc3545'}">
                                ${isActive ? 'Hoạt động' : 'Nghỉ học'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editSv('${sv._id}', '${sv.Ten}', '${sv.MSSV}')">Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSv('${sv._id}')">Xóa</button>
                        </td>
                    </tr>`;
                });
            } catch (err) { showToast('Lỗi tải sinh viên!', 'danger'); }
        }
        async function toggleSvStatus(id, isActive) {
            try {
                await fetch(`http://localhost:5000/sinhvien/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Is_active: isActive })
                });
                showToast(`Đã chuyển sang <strong>${isActive ? 'Hoạt động' : 'Nghỉ học'}</strong>`, 'success');
                loadSinhVien();
            } catch (err) { showToast('Lỗi cập nhật!', 'danger'); }
        }
        document.getElementById('addSinhVienForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editSvId').value;
            const ten = document.getElementById('tenSV').value.trim();
            const mssv = document.getElementById('mssvSV').value.trim();
            if (!ten || !mssv) return showToast('Nhập đầy đủ!', 'warning');
            const url = id ? `http://localhost:5000/sinhvien/${id}` : 'http://localhost:5000/sinhvien';
            const method = id ? 'PUT' : 'POST';
            const body = id ? { Ten: ten, MSSV: mssv } : { Ten: ten, MSSV: mssv, Is_active: true };
            try {
                const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (res.ok) {
                    showToast(id ? 'Cập nhật thành công!' : 'Thêm sinh viên thành công!', 'success');
                    loadSinhVien();
                    resetSvForm();
                }
            } catch (err) { showToast('Lỗi!', 'danger'); }
        });
        function editSv(id, ten, mssv) {
            document.getElementById('editSvId').value = id;
            document.getElementById('tenSV').value = ten;
            document.getElementById('mssvSV').value = mssv;
            document.querySelector('#addSinhVienForm button[type="submit"]').textContent = 'Cập nhật';
        }
        function resetSvForm() {
            document.getElementById('addSinhVienForm').reset();
            document.getElementById('editSvId').value = '';
            document.querySelector('#addSinhVienForm button[type="submit"]').textContent = 'Thêm';
        }
        function deleteSv(id) {
            if (confirm('Xóa sinh viên này?')) {
                fetch(`http://localhost:5000/sinhvien/${id}`, { method: 'DELETE' })
                    .then(() => { showToast('Đã xóa!', 'success'); loadSinhVien(); })
                    .catch(() => showToast('Lỗi xóa!', 'danger'));
            }
        }
        // ========== THIẾT BỊ ==========
        async function loadSinhVienForDropdown() {
            try {
                const res = await fetch('http://localhost:5000/sinhvien');
                const data = await res.json();
                const select = document.getElementById('svIdTB');
                select.innerHTML = '<option value="">-- Chọn Sinh viên --</option>';
                data.forEach(sv => {
                    const opt = document.createElement('option');
                    opt.value = sv._id;
                    opt.textContent = `${sv.Ten} - ${sv.MSSV}`;
                    select.appendChild(opt);
                });
            } catch (err) { console.error(err); }
        }
        async function loadThietBi() {
            try {
                const [tbRes, svRes] = await Promise.all([
                    fetch('http://localhost:5000/thietbi'),
                    fetch('http://localhost:5000/sinhvien')
                ]);
                const thietBi = await tbRes.json();
                const sinhVien = await svRes.json();
                const svMap = {};
                sinhVien.forEach(sv => svMap[sv._id] = `${sv.Ten} - ${sv.MSSV}`);
                const tbody = document.querySelector('#thietBiTable tbody');
                tbody.innerHTML = '';
                thietBi.forEach(tb => {
                    const tenSV = svMap[tb.SinhVien_id] || 'Chưa gán';
                    const ngayThem = tb.TD_Them_ThietBi
                        ? new Date(tb.TD_Them_ThietBi).toLocaleString('vi-VN')
                        : 'N/A';
                    tbody.innerHTML += `
                    <tr>
                        <td><small class="text-muted">${tb._id.slice(-6)}</small></td>
                        <td><strong>${tenSV}</strong></td>
                        <td class="mac-col">${tb.MAC}</td>
                        <td>${tb.Ten_ThietBi}</td>
                        <td><small>${ngayThem}</small></td>
                        <td>
                            <span class="badge ${tb.Is_active ? 'bg-success' : 'bg-secondary'}">
                                ${tb.Is_active ? 'Hoạt động' : 'Không hoạt động'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning"
                                    onclick="editThietBi(this)"
                                    data-id="${tb._id}"
                                    data-svid="${tb.SinhVien_id}"
                                    data-mac="${tb.MAC}"
                                    data-ten="${tb.Ten_ThietBi}">
                                Sửa
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTb('${tb._id}')">
                                Xóa
                            </button>
                        </td>
                    </tr>`;
                });
            } catch (err) {
                showToast('Lỗi tải thiết bị!', 'danger');
            }
        }
        // FIX HOÀN TOÀN LỖI ObjectId
        function editThietBi(button) {
            const id = button.getAttribute('data-id');
            const svId = button.getAttribute('data-svid'); // ObjectId nguyên bản
            const mac = button.getAttribute('data-mac');
            const ten = button.getAttribute('data-ten');
            document.getElementById('editTbId').value = id;
            document.getElementById('macTB').value = mac;
            document.getElementById('tenTB').value = ten;
            loadSinhVienForDropdown().then(() => {
                const select = document.getElementById('svIdTB');
                select.value = svId;
                if (select.value !== svId) {
                    for (let opt of select.options) {
                        if (opt.value === svId) { opt.selected = true; break; }
                    }
                }
            });
            document.querySelector('#addThietBiForm button[type="submit"]').textContent = 'Cập nhật';
            showToast('Đã tải thông tin thiết bị', 'success');
        }
        document.getElementById('addThietBiForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editTbId').value;
            const svId = document.getElementById('svIdTB').value;
            const mac = document.getElementById('macTB').value.toUpperCase().trim();
            const ten = document.getElementById('tenTB').value.trim();
            if (!svId) return showToast('Chọn sinh viên!', 'warning');
            if (!mac || !ten) return showToast('Nhập đầy đủ!', 'warning');
            const url = editId ? `http://localhost:5000/thietbi/${editId}` : 'http://localhost:5000/thietbi';
            const method = editId ? 'PUT' : 'POST';
            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ SinhVien_id: svId, MAC: mac, Ten_ThietBi: ten })
                });
                if (res.ok) {
                    showToast(editId ? 'Cập nhật thành công!' : 'Thêm thiết bị thành công!', 'success');
                    loadThietBi();
                    resetTbForm();
                } else {
                    const err = await res.json();
                    showToast(err.message || 'Lỗi server!', 'danger');
                }
            } catch (err) {
                showToast('Lỗi kết nối!', 'danger');
            }
        });
        function resetTbForm() {
            document.getElementById('addThietBiForm').reset();
            document.getElementById('editTbId').value = '';
            document.querySelector('#addThietBiForm button[type="submit"]').textContent = 'Thêm';
        }
        function deleteTb(id) {
            if (confirm('Xóa thiết bị này?')) {
                fetch(`http://localhost:5000/thietbi/${id}`, { method: 'DELETE' })
                    .then(() => { showToast('Đã xóa!', 'success'); loadThietBi(); })
                    .catch(() => showToast('Lỗi!', 'danger'));
            }
        }
        // ========== ĐIỂM DANH ==========
        async function loadSinhVienForDiemDanh() {
            try {
                const [svRes, tbRes] = await Promise.all([
                    fetch('http://localhost:5000/sinhvien'),
                    fetch('http://localhost:5000/thietbi')
                ]);
                const sinhVien = await svRes.json();
                const thietBi = await tbRes.json();
                mapSinhVienToMac = {};
                thietBi.forEach(tb => {
                    if (tb.SinhVien_id && !mapSinhVienToMac[tb.SinhVien_id]) {
                        mapSinhVienToMac[tb.SinhVien_id] = tb.MAC;
                    }
                });
                const select = document.getElementById('svSelectDD');
                select.innerHTML = '<option value="">-- Chọn Sinh viên --</option>';
                sinhVien.forEach(sv => {
                    if (mapSinhVienToMac[sv._id]) {
                        const opt = document.createElement('option');
                        opt.value = sv._id;
                        opt.textContent = `${sv.Ten} - ${sv.MSSV}`;
                        select.appendChild(opt);
                    }
                });
            } catch (err) { console.error(err); }
        }
        document.getElementById('svSelectDD')?.addEventListener('change', function() {
            document.getElementById('macDD').value = mapSinhVienToMac[this.value] || '';
        });
        async function loadDiemDanh() {
            try {
                const res = await fetch('http://localhost:5000/diemdanh');
                const data = await res.json();
                const tbody = document.querySelector('#diemDanhTable tbody');
                tbody.innerHTML = '';
                data.sort((a, b) => {
                    const timeA = a.TD_Vao ? new Date(a.TD_Vao) : 0;
                    const timeB = b.TD_Vao ? new Date(b.TD_Vao) : 0;
                    return timeB - timeA;
                });
                data.forEach(dd => {
                    const isoDate = dd.TD_Vao ? new Date(dd.TD_Vao).toISOString().split('T')[0] : '';
                    const ngayDisplay = dd.TD_Vao
                        ? new Date(dd.TD_Vao).toLocaleDateString('vi-VN', {
                            weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric'
                          }).replace(',', '')
                        : '<span class="text-muted">Chưa điểm danh</span>';
                    let statusClass = 'badge ';
                    let statusText = dd.TrangThai || 'Chưa xác định';
                    if (statusText.includes('Có mặt') && !statusText.includes('trễ') && !statusText.includes('sớm')) statusClass += 'bg-success';
                    else if (statusText.includes('Vắng - Về sớm') || statusText.includes('Vắng')) statusClass += 'bg-warning text-dark';
                    else if (statusText.includes('Đi trễ') || statusText.includes('Về sớm')) statusClass += 'bg-danger';
                    else statusClass += 'bg-secondary';
                    tbody.innerHTML += `
                    <tr data-ngay="${isoDate}">
                        <td><strong>${dd.Ten_SinhVien}</strong></td>
                        <td class="mac-col">${dd.MAC}</td>
                        <td><span class="badge bg-info">${dd.Buoi}</span></td>
                        <td>${dd.TD_Vao ? new Date(dd.TD_Vao).toLocaleTimeString('vi-VN') : '-'}</td>
                        <td>${dd.TD_Ra ? new Date(dd.TD_Ra).toLocaleTimeString('vi-VN') : '<small class="text-muted">Chưa ra</small>'}</td>
                        <td><strong>${ngayDisplay}</strong></td>
                        <td><span class="${statusClass} p-2 rounded">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="openEditModal('${dd._id}', '${dd.Ten_SinhVien}', '${dd.TD_Vao || ''}', '${dd.TD_Ra || ''}', '${dd.TrangThai}')">Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteDd('${dd._id}')">Xóa</button>
                        </td>
                    </tr>`;
                });
                filterTable(); // Áp dụng lọc sau khi tải dữ liệu
            } catch (err) {
                showToast('Lỗi tải điểm danh!', 'danger');
            }
        }
        document.getElementById('diemDanhForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const mac = document.getElementById('macDD').value.toUpperCase();
            const msgDiv = document.getElementById('ddMessage');
            if (!mac) return msgDiv.innerHTML = '<div class="alert alert-warning">Chọn sinh viên!</div>';
            try {
                const res = await fetch('http://localhost:5000/diemdanh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ MAC: mac })
                });
                const data = await res.json();
                msgDiv.innerHTML = res.ok ?
                    `<div class="alert alert-success">${data.message} - ${data.Ten_SinhVien}: ${data.TrangThai}</div>` :
                    `<div class="alert alert-danger">${data.message}</div>`;
                if (res.ok) { loadDiemDanh(); e.target.reset(); document.getElementById('macDD').value = ''; }
            } catch (err) { msgDiv.innerHTML = '<div class="alert alert-danger">Lỗi kết nối!</div>'; }
        });
        function deleteDd(id) {
            if (confirm('Xóa?')) {
                fetch(`http://localhost:5000/diemdanh/${id}`, { method: 'DELETE' })
                    .then(() => loadDiemDanh());
            }
        }
        // Hàm lọc bảng
        function filterTable() {
            const dateFilter = document.getElementById('filterNgay').value;
            const rows = document.querySelectorAll('#diemDanhTable tbody tr');
            rows.forEach(row => {
                const ngay = row.dataset.ngay;
                let show = true;
                if (dateFilter && ngay !== dateFilter) show = false;
                row.style.display = show ? '' : 'none';
            });
        }
        // ========== CÀI ĐẶT ==========
        async function loadCaiDat() {
            try {
                const res = await fetch('http://localhost:5000/caidat');
                const data = await res.json();
                const tbody = document.querySelector('#caiDatTable tbody');
                tbody.innerHTML = '';
                data.forEach(cd => {
                    tbody.innerHTML += `<tr>
                        <td><small>${cd._id.slice(-6)}</small></td>
                        <td>${cd.Buoi}</td><td>${cd.TD_BatDau}</td><td>${cd.TD_KetThuc}</td>
                        <td>${cd.TD_Reset || 'N/A'}</td><td>${cd.Mail || 'N/A'}</td><td>${cd.TG_DiTre || 0}</td>
                        <td>${cd.TD_Setting ? new Date(cd.TD_Setting).toLocaleString('vi-VN') : 'N/A'}</td>
                        <td><span class="badge ${cd.Is_active ? 'bg-success' : 'bg-secondary'}">${cd.Is_active ? 'Hoạt động' : 'Không hoạt động'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editCd('${cd._id}', '${cd.Buoi}', '${cd.TD_BatDau}', '${cd.TD_KetThuc}', '${cd.TD_Reset || ''}', '${cd.Mail || ''}', ${cd.TG_DiTre || 0})">Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCd('${cd._id}')">Xóa</button>
                        </td>
                    </tr>`;
                });
            } catch (err) { showToast('Lỗi tải cài đặt!', 'danger'); }
        }
        document.getElementById('addCaiDatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editCdId').value;
            const buoi = document.getElementById('buoiCD').value;
            const tdBatDau = document.getElementById('tdBatDau').value;
            const tdKetThuc = document.getElementById('tdKetThuc').value;
            const tdReset = document.getElementById('tdReset').value;
            const mail = document.getElementById('mailCD').value;
            const tgDiTre = parseInt(document.getElementById('tgDiTre').value) || 0;
            if (tdBatDau >= tdKetThuc) return alert('Thời gian bắt đầu phải trước kết thúc!');
            const url = editId ? `http://localhost:5000/caidat/${editId}` : 'http://localhost:5000/caidat';
            const method = editId ? 'PUT' : 'POST';
            await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ Buoi: buoi, TD_BatDau: tdBatDau, TD_KetThuc: tdKetThuc, TD_Reset: tdReset, Mail: mail, TG_DiTre: tgDiTre })
            });
            loadCaiDat();
            resetCdForm();
        });
        function editCd(id, buoi, tdBatDau, tdKetThuc, tdReset, mail, tgDiTre) {
            document.getElementById('editCdId').value = id;
            document.getElementById('buoiCD').value = buoi;
            document.getElementById('tdBatDau').value = tdBatDau;
            document.getElementById('tdKetThuc').value = tdKetThuc;
            document.getElementById('tdReset').value = tdReset;
            document.getElementById('mailCD').value = mail;
            document.getElementById('tgDiTre').value = tgDiTre;
            document.querySelector('#addCaiDatForm button[type="submit"]').textContent = 'Cập nhật';
        }
        function resetCdForm() {
            document.getElementById('addCaiDatForm').reset();
            document.getElementById('editCdId').value = '';
            document.getElementById('tgDiTre').value = '0';
            document.querySelector('#addCaiDatForm button[type="submit"]').textContent = 'Thêm';
        }
        function deleteCd(id) {
            if (confirm('Xóa cài đặt này?')) {
                fetch(`http://localhost:5000/caidat/${id}`, { method: 'DELETE' })
                    .then(() => loadCaiDat());
            }
        }
        // ========== MODAL SỬA ĐIỂM DANH (CẬP NHẬT FIX LỖI) ==========
        function openEditModal(id, tenSV, tdVaoStr, tdRaStr, trangthai) {
            document.getElementById('editDdId').value = id;
            document.getElementById('editTenSV').value = tenSV;
           
            // Xử lý TD_Vao an toàn
            let tdVao = '';
            if (tdVaoStr && tdVaoStr !== 'null' && tdVaoStr !== 'undefined' && tdVaoStr.trim() !== '') {
                const parts = tdVaoStr.split(' ');
                if (parts.length > 1 && parts[1]) {
                    tdVao = parts[1].substring(0, 5);
                }
            }
            document.getElementById('editTDVao').value = tdVao;
           
            // Xử lý TD_Ra an toàn
            let tdRa = '';
            if (tdRaStr && tdRaStr !== 'null' && tdRaStr !== 'undefined' && tdRaStr.trim() !== '') {
                const parts = tdRaStr.split(' ');
                if (parts.length > 1 && parts[1]) {
                    tdRa = parts[1].substring(0, 5);
                }
            }
            document.getElementById('editTDRa').value = tdRa;
           
            editModal = new bootstrap.Modal(document.getElementById('editDiemDanhModal'));
            editModal.show();
        }
        async function saveEditDiemDanh() {
            const id = document.getElementById('editDdId').value;
            const tdVao = document.getElementById('editTDVao').value.trim();
            const tdRa = document.getElementById('editTDRa').value.trim();
            const msgDiv = document.getElementById('editDdMessage');
            if (!tdVao || !/^\d{2}:\d{2}$/.test(tdVao)) {
                msgDiv.innerHTML = '<div class="alert alert-danger">Giờ vào không hợp lệ (HH:MM)!</div>';
                return;
            }
            const body = { TD_Vao: tdVao };
            if (tdRa && /^\d{2}:\d{2}$/.test(tdRa)) {
                body.TD_Ra = tdRa;
            }
            try {
                console.log('Sending PUT to:', `http://localhost:5000/diemdanh/${id}`, 'Body:', body); // Debug log
                const res = await fetch(`http://localhost:5000/diemdanh/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                console.log('Response:', res.ok, data); // Debug log
                msgDiv.innerHTML = res.ok
                    ? `<div class="alert alert-success">${data.message}</div>`
                    : `<div class="alert alert-danger">${data.message}</div>`;
                if (res.ok) {
                    setTimeout(() => {
                        editModal.hide();
                        loadDiemDanh();
                        document.getElementById('editDiemDanhForm').reset();
                    }, 1500);
                }
            } catch (err) {
                console.error('Fetch error:', err); // Debug log
                msgDiv.innerHTML = '<div class="alert alert-danger">Lỗi kết nối! Kiểm tra backend có chạy không (python run.py).</div>';
            }
        }
        // ========== KHỞI TẠO ==========
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('loggedIn') === 'true') {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                showPage('dashboard');
            }
            // Thêm event listeners cho lọc
            const filterNgay = document.getElementById('filterNgay');
            if (filterNgay) filterNgay.addEventListener('change', filterTable);
        });
        // ======================== HÀM XUẤT EXCEL ========================
        function exportToExcel() {
            const table = document.getElementById('diemDanhTable');
            const rows = table.querySelectorAll('tbody tr');
            if (rows.length === 0) {
                showToast('Chưa có dữ liệu điểm danh để xuất!', 'warning');
                return;
            }
            const data = [];
            data.push(['STT', 'Tên Sinh Viên', 'MAC', 'Buổi', 'Ngày', 'Giờ Vào', 'Giờ Ra', 'Trạng Thái']);
            rows.forEach((row, index) => {
                const cols = row.querySelectorAll('td');
                const tenSV = cols[0].textContent.trim();
                const mac = cols[1].textContent.trim();
                const buoi = cols[2].textContent.trim();
                const gioVao = cols[3].textContent.trim();
                const gioRa = cols[4].innerHTML.includes('Chưa ra') ? 'Chưa ra' : cols[4].textContent.trim();
                const ngay = cols[5].querySelector('strong') ? cols[5].querySelector('strong').textContent.trim() : cols[5].textContent.trim();
                const trangThai = cols[6].textContent.trim();
                data.push([index + 1, tenSV, mac, buoi, ngay, gioVao, gioRa, trangThai]);
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [
                { wch: 6 }, { wch: 25 }, { wch: 18 }, { wch: 10 },
                { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 22 }
            ];
            const headerStyle = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "4F46E5" } },
                alignment: { horizontal: "center", vertical: "center" }
            };
            for (let i = 0; i < 8; i++) {
                const cell = ws[XLSX.utils.encode_cell({ r: 0, c: i })];
                if (cell) cell.s = headerStyle;
            }
            XLSX.utils.book_append_sheet(wb, ws, "DiemDanh");
            const today = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
            XLSX.writeFile(wb, `DanhSach_DiemDanh_${today}.xlsx`);
            showToast('Đã xuất file Excel thành công!', 'success');
        }
    </script>
</body>
</html>