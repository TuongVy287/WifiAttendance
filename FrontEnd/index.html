<!-- app.html: File HTML duy nh·∫•t g·ªôp t·∫•t c·∫£ 5 trang (ƒêƒÉng nh·∫≠p, Dashboard, Sinh vi√™n, Thi·∫øt b·ªã, ƒêi·ªÉm danh, C√†i ƒë·∫∑t) th√†nh SPA -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Ghi ch√∫: CSS chung cho to√†n b·ªô ·ª©ng d·ª•ng SPA, t·∫°o giao di·ªán chuy√™n nghi·ªáp, b·∫Øt m·∫Øt v·ªõi ch·ªß ƒë·ªÅ WiFi */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        /* Ghi ch√∫: CSS cho sidebar navigation chuy√™n nghi·ªáp */
        .sidebar {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            position: fixed;
            width: 250px;
            z-index: 1000;
        }
        .nav-link {
            color: white !important;
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
        }
        .main-content {
            margin-left: 250px;
            padding: 2rem;
        }
        /* Ghi ch√∫: CSS cho c√°c trang ·∫©n/hi·ªán trong SPA */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .welcome-card {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .form-add {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .table-container {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .mac-col {
            font-family: monospace;
            font-weight: bold;
            color: #667eea;
        }
        /* Ghi ch√∫: CSS cho tr·∫°ng th√°i ƒëi·ªÉm danh */
        .status-co-mat { background-color: #d4edda; color: #155724; }
        .status-vang { background-color: #fff3cd; color: #856404; }
        .status-di-tre, .status-ve-som { background-color: #f8d7da; color: #721c24; }
        /* Ghi ch√∫: CSS cho trang ƒëƒÉng nh·∫≠p */
        .login-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
        }
        .wifi-icon {
            font-size: 3rem;
            color: #667eea;
            text-align: center;
            margin-bottom: 1rem;
        }
        /* Ghi ch√∫: Responsive cho mobile */
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; position: relative; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <!-- Ghi ch√∫: Trang ƒëƒÉng nh·∫≠p (hi·ªÉn th·ªã ƒë·∫ßu ti√™n) -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-card">
                <div class="wifi-icon">üì∂</div> <!-- Ghi ch√∫: Icon WiFi t∆∞·ª£ng tr∆∞ng cho ƒë·ªÅ t√†i ƒëi·ªÉm danh qua WiFi -->
                <h2 class="text-center mb-4">WiFi Attendance</h2>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">M·∫≠t kh·∫©u</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">ƒêƒÉng Nh·∫≠p</button>
                </form>
                <div id="loginMessage" class="mt-3 text-center"></div>
            </div>
        </div>
    </div>

    <!-- Ghi ch√∫: N·ªôi dung ch√≠nh sau ƒëƒÉng nh·∫≠p (·∫©n ban ƒë·∫ßu) -->
    <div id="mainApp" style="display: none;">
        <!-- Sidebar chung -->
        <div class="sidebar">
            <div class="p-3 text-white">
                <h4>üì∂ WiFi Attendance</h4>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" href="#" onclick="showPage('dashboard')">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('sinhvien')">Danh s√°ch Sinh vi√™n</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('thietbi')">Danh s√°ch Thi·∫øt b·ªã</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('diemdanh')">ƒêi·ªÉm danh</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('caidat')">C√†i ƒë·∫∑t</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">ƒêƒÉng xu·∫•t</a></li>
            </ul>
        </div>

        <!-- Trang Dashboard -->
        <div id="dashboardPage" class="page">
            <div class="main-content">
                <div class="welcome-card">
                    <h2>Ch√†o m·ª´ng ƒë·∫øn v·ªõi H·ªá th·ªëng ƒêi·ªÉm danh WiFi</h2>
                    <p>Qu·∫£n l√Ω ƒëi·ªÉm danh sinh vi√™n qua k·∫øt n·ªëi WiFi m·ªôt c√°ch t·ª± ƒë·ªông v√† ch√≠nh x√°c.</p>
                    <!-- Ghi ch√∫: Th·ªëng k√™ load t·ª´ API qua loadDashboardStats() -->
                    <div class="row mt-4" id="statsRow">
                        <div class="col-md-3">
                            <div class="card text-center p-3">
                                <h5 id="svCount">0</h5>
                                <p>Sinh vi√™n</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center p-3">
                                <h5 id="tbCount">0</h5>
                                <p>Thi·∫øt b·ªã</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center p-3">
                                <h5 id="attendanceRate">0%</h5>
                                <p>T·ª∑ l·ªá C√≥ m·∫∑t</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center p-3">
                                <h5 id="currentSession">S√°ng</h5>
                                <p>Bu·ªïi Hi·ªán t·∫°i</p>
                            </div>
                        </div>
                    </div>
                    <!-- Ghi ch√∫: Th√¥ng b√°o tr·∫°ng th√°i scan t·ª´ backend n·∫øu c√≥ endpoint, ·ªü ƒë√¢y gi·∫£ l·∫≠p -->
                    <div id="scanStatus" class="mt-3 alert alert-info" style="display: none;">Qu√©t WiFi ƒëang ho·∫°t ƒë·ªông...</div>
                </div>
            </div>
        </div>

        <!-- Trang Sinh vi√™n -->
        <div id="sinhvienPage" class="page">
            <div class="main-content">
                <h2>Danh s√°ch Sinh vi√™n</h2>
                <div class="form-add">
                    <h5>Th√™m/S·ª≠a Sinh vi√™n</h5>
                    <form id="addSinhVienForm">
                        <input type="hidden" id="editSvId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>T√™n</label>
                                <input type="text" class="form-control" id="tenSV" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>MSSV</label>
                                <input type="text" class="form-control" id="mssvSV" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Th√™m</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetSvForm()">H·ªßy</button>
                    </form>
                </div>
                <div class="table-container">
                    <table class="table table-striped" id="sinhVienTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T√™n</th>
                                <th>MSSV</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Trang Thi·∫øt b·ªã -->
        <div id="thietbiPage" class="page">
            <div class="main-content">
                <h2>Danh s√°ch Thi·∫øt b·ªã</h2>
                <div class="form-add">
                    <h5>Th√™m/S·ª≠a Thi·∫øt b·ªã</h5>
                    <form id="addThietBiForm">
                        <input type="hidden" id="editTbId">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label>Sinh vi√™n ID</label>
                                <input type="text" class="form-control" id="svIdTB" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label>MAC</label>
                                <input type="text" class="form-control" id="macTB" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label>T√™n Thi·∫øt b·ªã</label>
                                <input type="text" class="form-control" id="tenTB" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Th√™m</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetTbForm()">H·ªßy</button>
                    </form>
                </div>
                <div class="table-container">
                    <table class="table table-striped" id="thietBiTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Sinh vi√™n ID</th>
                                <th>MAC</th>
                                <th>T√™n Thi·∫øt b·ªã</th>
                                <th>Th·ªùi gian Th√™m</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Trang ƒêi·ªÉm danh -->
        <div id="diemdanhPage" class="page">
            <div class="main-content">
                <h2>ƒêi·ªÉm danh</h2>
                <div class="form-add">
                    <h5>ƒêi·ªÉm danh Th·ªß c√¥ng (Check-in/Check-out)</h5>
                    <p class="text-muted small">Nh·∫≠p MAC ƒë·ªÉ ghi nh·∫≠n ƒëi·ªÉm danh. L·∫ßn ƒë·∫ßu: Check-in, l·∫ßn sau: Check-out v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i.</p>
                    <form id="diemDanhForm">
                        <div class="mb-3">
                            <label>MAC</label>
                            <input type="text" class="form-control" id="macDD" placeholder="V√≠ d·ª•: AA:BB:CC:DD:EE:FF" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Ghi nh·∫≠n ƒêi·ªÉm danh</button>
                    </form>
                    <div id="ddMessage" class="mt-2"></div>
                </div>
                <div class="table-container">
                    <table class="table table-striped" id="diemDanhTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T√™n SV</th>
                                <th>MAC</th>
                                <th>Bu·ªïi</th>
                                <th>Th·ªùi gian V√†o</th>
                                <th>Th·ªùi gian Ra</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Trang C√†i ƒë·∫∑t -->
        <div id="caidatPage" class="page">
            <div class="main-content">
                <h2>C√†i ƒë·∫∑t Bu·ªïi H·ªçc</h2>
                <div class="form-add">
                    <h5>Th√™m/S·ª≠a C√†i ƒë·∫∑t</h5>
                    <p class="text-muted small">C·∫•u h√¨nh th·ªùi gian cho t·ª´ng bu·ªïi ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông x√°c ƒë·ªãnh tr·∫°ng th√°i ƒëi·ªÉm danh.</p>
                    <form id="addCaiDatForm">
                        <input type="hidden" id="editCdId">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label>Bu·ªïi</label>
                                <select class="form-control" id="buoiCD" required>
                                    <option value="">Ch·ªçn bu·ªïi</option>
                                    <option value="S√°ng">S√°ng</option>
                                    <option value="Chi·ªÅu">Chi·ªÅu</option>
                                    <option value="T·ªëi">T·ªëi</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label>Th·ªùi gian B·∫Øt ƒë·∫ßu (HH:MM)</label>
                                <input type="time" class="form-control" id="tdBatDau" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label>Th·ªùi gian K·∫øt th√∫c (HH:MM)</label>
                                <input type="time" class="form-control" id="tdKetThuc" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label>Th·ªùi gian Reset (HH:MM)</label>
                                <input type="time" class="form-control" id="tdReset">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Email Th√¥ng b√°o</label>
                                <input type="email" class="form-control" id="mailCD" placeholder="email@domain.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Th·ªùi gian ƒêi tr·ªÖ (ph√∫t)</label>
                                <input type="number" class="form-control" id="tgDiTre" value="0" min="0">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Th√™m</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetCdForm()">H·ªßy</button>
                    </form>
                </div>
                <div class="table-container">
                    <table class="table table-striped" id="caiDatTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Bu·ªïi</th>
                                <th>TD B·∫Øt ƒë·∫ßu</th>
                                <th>TD K·∫øt th√∫c</th>
                                <th>TD Reset</th>
                                <th>Email</th>
                                <th>TG ƒêi tr·ªÖ</th>
                                <th>Th·ªùi gian Setting</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Ghi ch√∫: JavaScript chung cho SPA: show/hide pages v√† gh√©p n·ªëi API ƒë·∫ßy ƒë·ªß
        let refreshInterval; // Ghi ch√∫: Interval ƒë·ªÉ auto-refresh d·ªØ li·ªáu ƒëi·ªÉm danh (t∆∞∆°ng ·ª©ng scan interval 10s ·ªü backend)

        function showPage(pageName) {
            // ·∫®n t·∫•t c·∫£ pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            // Hi·ªÉn th·ªã page t∆∞∆°ng ·ª©ng
            document.getElementById(pageName + 'Page').classList.add('active');
            // C·∫≠p nh·∫≠t active nav
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            // Load data n·∫øu c·∫ßn (gh√©p n·ªëi API)
            if (pageName === 'dashboard') loadDashboardStats();
            else if (pageName === 'sinhvien') loadSinhVien();
            else if (pageName === 'thietbi') loadThietBi();
            else if (pageName === 'diemdanh') {
                loadDiemDanh();
                startRefreshDiemDanh(); // Ghi ch√∫: B·∫Øt ƒë·∫ßu auto-refresh khi v√†o trang ƒëi·ªÉm danh ƒë·ªÉ theo d√µi scan t·ª± ƒë·ªông
            } else if (pageName === 'caidat') loadCaiDat();
        }

        function startRefreshDiemDanh() {
            // Ghi ch√∫: D·ª´ng interval c≈© n·∫øu c√≥, b·∫Øt ƒë·∫ßu m·ªõi m·ªói 10s (kh·ªõp SCAN_INTERVAL ·ªü backend)
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(loadDiemDanh, 10000);
            // Load ngay l·∫≠p t·ª©c
            loadDiemDanh();
        }

        function stopRefreshDiemDanh() {
            if (refreshInterval) clearInterval(refreshInterval);
        }

        // Ghi ch√∫: X·ª≠ l√Ω ƒëƒÉng nh·∫≠p (s·ª≠ d·ª•ng POST /dangnhap ƒë·ªÉ x√°c th·ª±c)
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');

            try {
                const response = await fetch('http://localhost:5000/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (response.ok) {
                    messageDiv.innerHTML = '<div class="alert alert-success">ƒêƒÉng nh·∫≠p th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...</div>';
                    // Ghi ch√∫: L∆∞u th√¥ng tin user n·∫øu c·∫ßn (kh√¥ng thay ƒë·ªïi backend)
                    localStorage.setItem('loggedIn', 'true');
                    setTimeout(() => {
                        document.getElementById('loginPage').classList.remove('active');
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        showPage('dashboard');
                    }, 1000);
                } else {
                    messageDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="alert alert-danger">L·ªói k·∫øt n·ªëi! Ki·ªÉm tra backend ƒëang ch·∫°y ch∆∞a.</div>';
            }
        });

        // Ghi ch√∫: H√†m ƒëƒÉng xu·∫•t
        function logout() {
            localStorage.removeItem('loggedIn');
            stopRefreshDiemDanh();
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('loginPage').classList.add('active');
            document.getElementById('loginForm').reset();
            document.getElementById('loginMessage').innerHTML = '';
        }

        // Ghi ch√∫: Load stats cho Dashboard (t√≠nh t·ª´ API data, kh√¥ng c·∫ßn endpoint m·ªõi)
        async function loadDashboardStats() {
            try {
                // Load sinhvien
                const svRes = await fetch('http://localhost:5000/sinhvien');
                const svData = await svRes.json();
                document.getElementById('svCount').textContent = svData.length;

                // Load thietbi
                const tbRes = await fetch('http://localhost:5000/thietbi');
                const tbData = await tbRes.json();
                document.getElementById('tbCount').textContent = tbData.length;

                // Load diemdanh h√¥m nay ƒë·ªÉ t√≠nh t·ª∑ l·ªá
                const ddRes = await fetch('http://localhost:5000/diemdanh');
                const ddData = await ddRes.json();
                const today = new Date().toISOString().split('T')[0];
                const todayRecords = ddData.filter(dd => dd.Ngay === today);
                const present = todayRecords.filter(dd => dd.TrangThai.includes('C√≥ m·∫∑t')).length;
                const totalSv = svData.length;
                const rate = totalSv > 0 ? Math.round((present / totalSv) * 100) : 0;
                document.getElementById('attendanceRate').textContent = rate + '%';

                // Bu·ªïi hi·ªán t·∫°i (t·ª´ logic backend)
                const now = new Date();
                const hour = now.getHours();
                let buoi = 'S√°ng';
                if (hour >= 12 && hour < 17) buoi = 'Chi·ªÅu';
                else if (hour >= 17) buoi = 'T·ªëi';
                document.getElementById('currentSession').textContent = buoi;

                // Ghi ch√∫: Hi·ªÉn th·ªã status scan (gi·∫£ l·∫≠p, c√≥ th·ªÉ poll n·∫øu backend c√≥ endpoint)
                document.getElementById('scanStatus').style.display = 'block';
            } catch (error) {
                console.error('L·ªói load stats:', error);
            }
        }

        // ========== SINH VI√äN ==========
        async function loadSinhVien() {
            try {
                const response = await fetch('http://localhost:5000/sinhvien');
                const data = await response.json();
                const tbody = document.querySelector('#sinhVienTable tbody');
                tbody.innerHTML = '';
                data.forEach(sv => {
                    const row = `<tr>
                        <td>${sv._id}</td>
                        <td>${sv.Ten}</td>
                        <td>${sv.MSSV}</td>
                        <td><span class="badge ${sv.Is_active ? 'bg-success' : 'bg-secondary'}">${sv.Is_active ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editSv('${sv._id}', '${sv.Ten}', '${sv.MSSV}')">S·ª≠a</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSv('${sv._id}')">X√≥a</button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('L·ªói t·∫£i danh s√°ch:', error);
                alert('L·ªói t·∫£i danh s√°ch sinh vi√™n!');
            }
        }

        document.getElementById('addSinhVienForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editSvId').value;
            const ten = document.getElementById('tenSV').value;
            const mssv = document.getElementById('mssvSV').value;
            const url = editId ? `http://localhost:5000/sinhvien/${editId}` : 'http://localhost:5000/sinhvien';
            const method = editId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Ten: ten, MSSV: mssv })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || 'Th√†nh c√¥ng!');
                    loadSinhVien();
                    resetSvForm();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi!');
            }
        });

        function editSv(id, ten, mssv) {
            document.getElementById('editSvId').value = id;
            document.getElementById('tenSV').value = ten;
            document.getElementById('mssvSV').value = mssv;
            document.querySelector('#addSinhVienForm button[type="submit"]').textContent = 'C·∫≠p nh·∫≠t';
        }

        function resetSvForm() {
            document.getElementById('addSinhVienForm').reset();
            document.getElementById('editSvId').value = '';
            document.querySelector('#addSinhVienForm button[type="submit"]').textContent = 'Th√™m';
        }

        function deleteSv(id) {
            if (confirm('X√°c nh·∫≠n x√≥a?')) {
                fetch(`http://localhost:5000/sinhvien/${id}`, { method: 'DELETE' })
                    .then(() => loadSinhVien())
                    .catch(error => alert('L·ªói x√≥a!'));
            }
        }

        // ========== THI·∫æT B·ªä ==========
        async function loadThietBi() {
            try {
                const response = await fetch('http://localhost:5000/thietbi');
                const data = await response.json();
                const tbody = document.querySelector('#thietBiTable tbody');
                tbody.innerHTML = '';
                data.forEach(tb => {
                    const row = `<tr>
                        <td>${tb._id}</td>
                        <td>${tb.SinhVien_id}</td>
                        <td class="mac-col">${tb.MAC}</td>
                        <td>${tb.Ten_ThietBi}</td>
                        <td>${tb.TD_Them_ThietBi}</td>
                        <td><span class="badge ${tb.Is_active ? 'bg-success' : 'bg-secondary'}">${tb.Is_active ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editTb('${tb._id}', '${tb.SinhVien_id}', '${tb.MAC}', '${tb.Ten_ThietBi}')">S·ª≠a</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTb('${tb._id}')">X√≥a</button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('L·ªói t·∫£i danh s√°ch:', error);
                alert('L·ªói t·∫£i danh s√°ch thi·∫øt b·ªã!');
            }
        }

        document.getElementById('addThietBiForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editTbId').value;
            const svId = document.getElementById('svIdTB').value;
            const mac = document.getElementById('macTB').value;
            const ten = document.getElementById('tenTB').value;
            const url = editId ? `http://localhost:5000/thietbi/${editId}` : 'http://localhost:5000/thietbi';
            const method = editId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ SinhVien_id: svId, MAC: mac, Ten_ThietBi: ten })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || 'Th√†nh c√¥ng!');
                    loadThietBi();
                    resetTbForm();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi!');
            }
        });

        function editTb(id, svId, mac, ten) {
            document.getElementById('editTbId').value = id;
            document.getElementById('svIdTB').value = svId;
            document.getElementById('macTB').value = mac;
            document.getElementById('tenTB').value = ten;
            document.querySelector('#addThietBiForm button[type="submit"]').textContent = 'C·∫≠p nh·∫≠t';
        }

        function resetTbForm() {
            document.getElementById('addThietBiForm').reset();
            document.getElementById('editTbId').value = '';
            document.querySelector('#addThietBiForm button[type="submit"]').textContent = 'Th√™m';
        }

        function deleteTb(id) {
            if (confirm('X√°c nh·∫≠n x√≥a?')) {
                fetch(`http://localhost:5000/thietbi/${id}`, { method: 'DELETE' })
                    .then(() => loadThietBi())
                    .catch(error => alert('L·ªói x√≥a!'));
            }
        }

        // ========== ƒêI·ªÇM DANH ==========
        // Ghi ch√∫: Logic gh√©p n·ªëi: POST /diemdanh x·ª≠ l√Ω check-in/check-out theo backend (kh√¥ng c√≥ Ngay trong response, nh∆∞ng filter ·ªü frontend)
        async function loadDiemDanh() {
            try {
                const response = await fetch('http://localhost:5000/diemdanh');
                const data = await response.json();
                const tbody = document.querySelector('#diemDanhTable tbody');
                tbody.innerHTML = '';
                // Ghi ch√∫: Filter h√¥m nay n·∫øu c√≥ Ngay, nh∆∞ng backend kh√¥ng lu√¥n c√≥, load t·∫•t c·∫£ v√† filter client-side
                const today = new Date().toISOString().split('T')[0];
                const todayData = data.filter(dd => dd.Ngay === today || !dd.Ngay); // Fallback n·∫øu kh√¥ng c√≥ Ngay
                todayData.forEach(dd => {
                    let statusClass = 'bg-secondary';
                    if (dd.TrangThai.includes('C√≥ m·∫∑t')) statusClass = 'status-co-mat';
                    else if (dd.TrangThai.includes('V·∫Øng')) statusClass = 'status-vang';
                    else if (dd.TrangThai.includes('ƒêi tr·ªÖ') || dd.TrangThai.includes('V·ªÅ s·ªõm')) statusClass = 'status-di-tre';
                    const row = `<tr>
                        <td>${dd._id}</td>
                        <td>${dd.Ten_SinhVien}</td>
                        <td class="mac-col">${dd.MAC}</td>
                        <td>${dd.Buoi}</td>
                        <td>${dd.TD_Vao ? new Date(dd.TD_Vao).toLocaleTimeString('vi-VN') : 'N/A'}</td>
                        <td>${dd.TD_Ra ? new Date(dd.TD_Ra).toLocaleTimeString('vi-VN') : 'Ch∆∞a c√≥'}</td>
                        <td><span class="badge ${statusClass} p-2">${dd.TrangThai}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editDd('${dd._id}')">S·ª≠a</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteDd('${dd._id}')">X√≥a</button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('L·ªói t·∫£i danh s√°ch:', error);
                alert('L·ªói t·∫£i danh s√°ch ƒëi·ªÉm danh!');
            }
        }

        document.getElementById('diemDanhForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const mac = document.getElementById('macDD').value.toUpperCase(); // Ghi ch√∫: Chu·∫©n h√≥a MAC nh∆∞ backend
            const messageDiv = document.getElementById('ddMessage');

            if (!mac.match(/^([0-9A-F]{2}[:-]){5}([0-9A-F]{2})$/)) {
                messageDiv.innerHTML = '<div class="alert alert-warning">MAC kh√¥ng h·ª£p l·ªá! V√≠ d·ª•: AA:BB:CC:DD:EE:FF</div>';
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/diemdanh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ MAC: mac })
                });
                const data = await response.json();
                if (response.ok) {
                    messageDiv.innerHTML = `<div class="alert alert-success">${data.message} - ${data.Ten_SinhVien}: ${data.TrangThai} (${data.Buoi})</div>`;
                    loadDiemDanh(); // Reload ngay ƒë·ªÉ hi·ªÉn th·ªã c·∫≠p nh·∫≠t
                    e.target.reset();
                } else {
                    messageDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="alert alert-danger">L·ªói k·∫øt n·ªëi!</div>';
            }
        });

        function editDd(id) {
            // Ghi ch√∫: Placeholder cho edit, c√≥ th·ªÉ m·ªü modal c·∫≠p nh·∫≠t TD_Vao/TD_Ra/Tr·∫°ngThai qua PUT /diemdanh/{id}
            alert('Ch·ª©c nƒÉng s·ª≠a: C·∫≠p nh·∫≠t tr·∫°ng th√°i cho ID ' + id + '. S·ª≠ d·ª•ng PUT API n·∫øu c·∫ßn.');
        }

        function deleteDd(id) {
            if (confirm('X√°c nh·∫≠n x√≥a?')) {
                fetch(`http://localhost:5000/diemdanh/${id}`, { method: 'DELETE' })
                    .then(() => loadDiemDanh())
                    .catch(error => alert('L·ªói x√≥a!'));
            }
        }

        // ========== C√ÄI ƒê·∫∂T ==========
        async function loadCaiDat() {
            try {
                const response = await fetch('http://localhost:5000/caidat');
                const data = await response.json();
                const tbody = document.querySelector('#caiDatTable tbody');
                tbody.innerHTML = '';
                data.forEach(cd => {
                    const row = `<tr>
                        <td>${cd._id}</td>
                        <td>${cd.Buoi}</td>
                        <td>${cd.TD_BatDau}</td>
                        <td>${cd.TD_KetThuc}</td>
                        <td>${cd.TD_Reset || 'N/A'}</td>
                        <td>${cd.Mail || 'N/A'}</td>
                        <td>${cd.TG_DiTre || 0}</td>
                        <td>${cd.TD_Setting ? new Date(cd.TD_Setting).toLocaleString('vi-VN') : 'N/A'}</td>
                        <td><span class="badge ${cd.Is_active ? 'bg-success' : 'bg-secondary'}">${cd.Is_active ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editCd('${cd._id}', '${cd.Buoi}', '${cd.TD_BatDau}', '${cd.TD_KetThuc}', '${cd.TD_Reset || ''}', '${cd.Mail || ''}', ${cd.TG_DiTre || 0})">S·ª≠a</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCd('${cd._id}')">X√≥a</button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('L·ªói t·∫£i danh s√°ch:', error);
                alert('L·ªói t·∫£i danh s√°ch c√†i ƒë·∫∑t!');
            }
        }

        document.getElementById('addCaiDatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editCdId').value;
            const buoi = document.getElementById('buoiCD').value;
            const tdBatDau = document.getElementById('tdBatDau').value;
            const tdKetThuc = document.getElementById('tdKetThuc').value;
            const tdReset = document.getElementById('tdReset').value;
            const mail = document.getElementById('mailCD').value;
            const tgDiTre = parseInt(document.getElementById('tgDiTre').value) || 0;
            const url = editId ? `http://localhost:5000/caidat/${editId}` : 'http://localhost:5000/caidat';
            const method = editId ? 'PUT' : 'POST';

            // Ghi ch√∫: Validate th·ªùi gian b·∫Øt ƒë·∫ßu < k·∫øt th√∫c
            if (new Date('1970-01-01T' + tdBatDau + ':00') >= new Date('1970-01-01T' + tdKetThuc + ':00')) {
                alert('Th·ªùi gian b·∫Øt ƒë·∫ßu ph·∫£i tr∆∞·ªõc th·ªùi gian k·∫øt th√∫c!');
                return;
            }

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Buoi: buoi, TD_BatDau: tdBatDau, TD_KetThuc: tdKetThuc, TD_Reset: tdReset, Mail: mail, TG_DiTre: tgDiTre })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || 'Th√†nh c√¥ng! C√†i ƒë·∫∑t s·∫Ω √°p d·ª•ng cho scan t·ª± ƒë·ªông.');
                    loadCaiDat();
                    resetCdForm();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi!');
            }
        });

        function editCd(id, buoi, tdBatDau, tdKetThuc, tdReset, mail, tgDiTre) {
            document.getElementById('editCdId').value = id;
            document.getElementById('buoiCD').value = buoi;
            document.getElementById('tdBatDau').value = tdBatDau;
            document.getElementById('tdKetThuc').value = tdKetThuc;
            document.getElementById('tdReset').value = tdReset;
            document.getElementById('mailCD').value = mail;
            document.getElementById('tgDiTre').value = tgDiTre;
            document.querySelector('#addCaiDatForm button[type="submit"]').textContent = 'C·∫≠p nh·∫≠t';
        }

        function resetCdForm() {
            document.getElementById('addCaiDatForm').reset();
            document.getElementById('editCdId').value = '';
            document.getElementById('tgDiTre').value = '0';
            document.querySelector('#addCaiDatForm button[type="submit"]').textContent = 'Th√™m';
        }

        function deleteCd(id) {
            if (confirm('X√°c nh·∫≠n x√≥a?')) {
                fetch(`http://localhost:5000/caidat/${id}`, { method: 'DELETE' })
                    .then(() => loadCaiDat())
                    .catch(error => alert('L·ªói x√≥a!'));
            }
        }

        // Ghi ch√∫: Kh·ªüi t·∫°o SPA, trang ƒëƒÉng nh·∫≠p hi·ªÉn th·ªã ƒë·∫ßu ti√™n. Ki·ªÉm tra login n·∫øu reload
        if (localStorage.getItem('loggedIn')) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            showPage('dashboard');
        }
    </script>
</body>
</html>