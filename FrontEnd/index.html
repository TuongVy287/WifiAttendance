<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .sidebar { background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); height: 100vh; position: fixed; width: 250px; z-index: 1000; }
        .nav-link { color: white !important; }
        .nav-link:hover, .nav-link.active { background: rgba(255, 255, 255, 0.2); }
        .main-content { margin-left: 250px; padding: 2rem; }
        .page { display: none; }
        .page.active { display: block; }
        .welcome-card, .form-add, .table-container { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .mac-col { font-family: monospace; font-weight: bold; color: #667eea; }
        .status-co-mat { background-color: #d4edda; color: #155724; }
        .status-vang { background-color: #fff3cd; color: #856404; }
        .status-di-tre, .status-ve-som { background-color: #f8d7da; color: #721c24; }
        .login-container { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); padding: 2rem; width: 100%; max-width: 400px; }
        .wifi-icon { font-size: 3rem; color: #667eea; text-align: center; margin-bottom: 1rem; }
        @media (max-width: 768px) { .sidebar { width: 100%; height: auto; position: relative; } .main-content { margin-left: 0; } }
    </style>
</head>
<body>
    <!-- Trang đăng nhập -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-card">
                <div class="wifi-icon">WiFi</div>
                <h2 class="text-center mb-4">WiFi Attendance</h2>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Tên đăng nhập</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Mật khẩu</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Đăng Nhập</button>
                </form>
                <div id="loginMessage" class="mt-3 text-center"></div>
            </div>
        </div>
    </div>

    <!-- Nội dung chính -->
    <div id="mainApp" style="display: none;">
        <div class="sidebar">
            <div class="p-3 text-white"><h4>WiFi Attendance</h4></div>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link active" href="#" onclick="showPage('dashboard')">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('sinhvien')">Danh sách Sinh viên</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('thietbi')">Danh sách Thiết bị</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('diemdanh')">Điểm danh</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('caidat')">Cài đặt</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Đăng xuất</a></li>
            </ul>
        </div>

        <!-- Dashboard -->
        <div id="dashboardPage" class="page">
            <div class="main-content">
                <div class="welcome-card">
                    <h2>Chào mừng đến với Hệ thống Điểm danh WiFi</h2>
                    <p>Quản lý điểm danh sinh viên qua kết nối WiFi một cách tự động và chính xác.</p>
                    <div class="row mt-4" id="statsRow">
                        <div class="col-md-3"><div class="card text-center p-3"><h5 id="svCount">0</h5><p>Sinh viên</p></div></div>
                        <div class="col-md-3"><div class="card text-center p-3"><h5 id="tbCount">0</h5><p>Thiết bị</p></div></div>
                        <div class="col-md-3"><div class="card text-center p-3"><h5 id="attendanceRate">0%</h5><p>Tỷ lệ Có mặt</p></div></div>
                        <div class="col-md-3"><div class="card text-center p-3"><h5 id="currentSession">Sáng</h5><p>Buổi Hiện tại</p></div></div>
                    </div>
                    <div id="scanStatus" class="mt-3 alert alert-info" style="display: none;">Quét WiFi đang hoạt động...</div>
                </div>
            </div>
        </div>

        <!-- Sinh viên -->
        <div id="sinhvienPage" class="page">
            <div class="main-content">
                <h2>Danh sách Sinh viên</h2>
                <div class="form-add">
                    <h5>Thêm/Sửa Sinh viên</h5>
                    <form id="addSinhVienForm">
                        <input type="hidden" id="editSvId">
                        <div class="row">
                            <div class="col-md-6 mb-3"><label>Tên</label><input type="text" class="form-control" id="tenSV" required></div>
                            <div class="col-md-6 mb-3"><label>MSSV</label><input type="text" class="form-control" id="mssvSV" required></div>
                        </div>
                        <button type="submit" class="btn btn-success">Thêm</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetSvForm()">Hủy</button>
                    </form>
                </div>
                <div class="table-container">
                    <table class="table table-striped" id="sinhVienTable">
                        <thead><tr><th>ID</th><th>Tên</th><th>MSSV</th><th>Trạng thái</th><th>Hành động</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Thiết bị -->
        <div id="thietbiPage" class="page">
            <div class="main-content">
                <h2>Danh sách Thiết bị</h2>
                <div class="form-add">
                    <h5>Thêm/Sửa Thiết bị</h5>
                    <form id="addThietBiForm">
                        <input type="hidden" id="editTbId">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label>Sinh viên ID</label>
                                <select class="form-control" id="svIdTB" required>
                                    <option value="">-- Chọn Sinh viên --</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label>MAC</label>
                                <input type="text" class="form-control" id="macTB" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label>Tên Thiết bị</label>
                                <input type="text" class="form-control" id="tenTB" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Thêm</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetTbForm()">Hủy</button>
                    </form>
                </div>
                <div class="table-container">
                    <table class="table table-striped" id="thietBiTable">
                        <thead><tr><th>ID</th><th>Sinh viên ID</th><th>MAC</th><th>Tên Thiết bị</th><th>Thời gian Thêm</th><th>Trạng thái</th><th>Hành động</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Điểm danh -->
        <div id="diemdanhPage" class="page">
            <div class="main-content">
                <h2>Điểm danh</h2>
                <div class="form-add">
                    <h5>Điểm danh Thủ công (Check-in/Check-out)</h5>
                    <p class="text-muted small">Chọn sinh viên → MAC tự động → Ghi nhận điểm danh.</p>
                    <form id="diemDanhForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Chọn Sinh viên</label>
                                <select class="form-control" id="svSelectDD" required>
                                    <option value="">-- Chọn Sinh viên --</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>MAC (Tự động)</label>
                                <input type="text" class="form-control" id="macDD" readonly placeholder="MAC sẽ hiển thị khi chọn SV">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Ghi nhận Điểm danh</button>
                    </form>
                    <div id="ddMessage" class="mt-2"></div>
                </div>
                <div class="table-container">
                    <table class="table table-striped" id="diemDanhTable">
                        <thead><tr><th>ID</th><th>Tên SV</th><th>MAC</th><th>Buổi</th><th>Thời gian Vào</th><th>Thời gian Ra</th><th>Trạng thái</th><th>Hành động</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Cài đặt -->
        <div id="caidatPage" class="page">
            <div class="main-content">
                <h2>Cài đặt Buổi Học</h2>
                <div class="form-add">
                    <h5>Thêm/Sửa Cài đặt</h5>
                    <form id="addCaiDatForm">
                        <input type="hidden" id="editCdId">
                        <div class="row">
                            <div class="col-md-3 mb-3"><label>Buổi</label>
                                <select class="form-control" id="buoiCD" required>
                                    <option value="">Chọn buổi</option>
                                    <option value="Sáng">Sáng</option>
                                    <option value="Chiều">Chiều</option>
                                    <option value="Tối">Tối</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3"><label>Thời gian Bắt đầu</label><input type="time" class="form-control" id="tdBatDau" required></div>
                            <div class="col-md-3 mb-3"><label>Thời gian Kết thúc</label><input type="time" class="form-control" id="tdKetThuc" required></div>
                            <div class="col-md-3 mb-3"><label>Thời gian Reset</label><input type="time" class="form-control" id="tdReset"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label>Email</label><input type="email" class="form-control" id="mailCD"></div>
                            <div class="col-md-6 mb-3"><label>Đi trễ (phút)</label><input type="number" class="form-control" id="tgDiTre" min="0" value="0"></div>
                        </div>
                        <button type="submit" class="btn btn-success">Thêm</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetCdForm()">Hủy</button>
                    </form>
                </div>
                <div class="table-container">
                    <table class="table table-striped" id="caiDatTable">
                        <thead><tr><th>ID</th><th>Buổi</th><th>Bắt đầu</th><th>Kết thúc</th><th>Reset</th><th>Email</th><th>Đi trễ</th><th>Thời gian</th><th>Trạng thái</th><th>Hành động</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== BIẾN TOÀN CỤC ==========
        let mapSinhVienToMac = {};

        // ========== SHOW PAGE ==========
        window.showPage = function(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const page = document.getElementById(pageName + 'Page');
            if (page) page.classList.add('active');

            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('active');
                if (l.getAttribute('onclick')?.includes(pageName)) l.classList.add('active');
            });

            if (pageName === 'dashboard') loadDashboardStats();
            else if (pageName === 'sinhvien') loadSinhVien();
            else if (pageName === 'thietbi') { loadThietBi(); loadSinhVienForDropdown(); }
            else if (pageName === 'diemdanh') { loadDiemDanh(); loadSinhVienForDiemDanh(); }
            else if (pageName === 'caidat') loadCaiDat();
        };

        // ========== ĐĂNG NHẬP ==========
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');

            try {
                const response = await fetch('http://localhost:5000/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (response.ok) {
                    messageDiv.innerHTML = '<div class="alert alert-success">Đăng nhập thành công! Đang chuyển hướng...</div>';
                    localStorage.setItem('loggedIn', 'true');
                    setTimeout(() => {
                        document.getElementById('loginPage').classList.remove('active');
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        showPage('dashboard');
                    }, 1000);
                } else {
                    messageDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="alert alert-danger">Lỗi kết nối! Kiểm tra backend đang chạy chưa.</div>';
            }
        });

        function logout() {
            localStorage.removeItem('loggedIn');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('loginPage').classList.add('active');
            document.getElementById('loginForm').reset();
            document.getElementById('loginMessage').innerHTML = '';
        }

        // ========== DASHBOARD ==========
        async function loadDashboardStats() {
            try {
                const [svRes, tbRes, ddRes] = await Promise.all([
                    fetch('http://localhost:5000/sinhvien'),
                    fetch('http://localhost:5000/thietbi'),
                    fetch('http://localhost:5000/diemdanh')
                ]);
                const sv = await svRes.json();
                const tb = await tbRes.json();
                const dd = await ddRes.json();
                document.getElementById('svCount').textContent = sv.length;
                document.getElementById('tbCount').textContent = tb.length;
                const today = new Date().toISOString().split('T')[0];
                const todayDD = dd.filter(d => d.Ngay === today);
                const coMat = todayDD.filter(d => d.TrangThai.includes('Có mặt')).length;
                const rate = todayDD.length > 0 ? Math.round((coMat / todayDD.length) * 100) : 0;
                document.getElementById('attendanceRate').textContent = rate + '%';
                const now = new Date();
                const hour = now.getHours();
                let buoi = 'Sáng';
                if (hour >= 12 && hour < 17) buoi = 'Chiều';
                else if (hour >= 17) buoi = 'Tối';
                document.getElementById('currentSession').textContent = buoi;
                document.getElementById('scanStatus').style.display = 'block';
            } catch (err) { console.error('Lỗi dashboard:', err); }
        }

        // ========== SINH VIÊN ==========
        async function loadSinhVien() {
            try {
                const res = await fetch('http://localhost:5000/sinhvien');
                const data = await res.json();
                const tbody = document.querySelector('#sinhVienTable tbody');
                tbody.innerHTML = '';
                data.forEach(sv => {
                    tbody.innerHTML += `<tr>
                        <td>${sv._id}</td>
                        <td>${sv.Ten}</td>
                        <td>${sv.MSSV}</td>
                        <td><span class="badge bg-success">Hoạt động</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editSv('${sv._id}', '${sv.Ten}', '${sv.MSSV}')">Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSv('${sv._id}')">Xóa</button>
                        </td>
                    </tr>`;
                });
            } catch (err) { alert('Lỗi tải sinh viên!'); }
        }

        document.getElementById('addSinhVienForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editSvId').value;
            const ten = document.getElementById('tenSV').value;
            const mssv = document.getElementById('mssvSV').value;
            const url = id ? `http://localhost:5000/sinhvien/${id}` : 'http://localhost:5000/sinhvien';
            const method = id ? 'PUT' : 'POST';
            await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ Ten: ten, MSSV: mssv }) });
            loadSinhVien(); resetSvForm();
        });

        function editSv(id, ten, mssv) {
            document.getElementById('editSvId').value = id;
            document.getElementById('tenSV').value = ten;
            document.getElementById('mssvSV').value = mssv;
            document.querySelector('#addSinhVienForm button[type="submit"]').textContent = 'Cập nhật';
        }

        function resetSvForm() {
            document.getElementById('addSinhVienForm').reset();
            document.getElementById('editSvId').value = '';
            document.querySelector('#addSinhVienForm button[type="submit"]').textContent = 'Thêm';
        }

        function deleteSv(id) {
            if (confirm('Xóa sinh viên này?')) {
                fetch(`http://localhost:5000/sinhvien/${id}`, { method: 'DELETE' }).then(() => loadSinhVien());
            }
        }

        // ========== THIẾT BỊ ==========
        async function loadSinhVienForDropdown() {
            try {
                const res = await fetch('http://localhost:5000/sinhvien');
                const data = await res.json();
                const select = document.getElementById('svIdTB');
                select.innerHTML = '<option value="">-- Chọn Sinh viên --</option>';
                data.forEach(sv => {
                    const opt = document.createElement('option');
                    opt.value = sv._id;
                    opt.textContent = `${sv.Ten} - ${sv.MSSV}`;
                    select.appendChild(opt);
                });
            } catch (err) { console.error('Lỗi load SV dropdown:', err); }
        }

        async function loadThietBi() {
            try {
                const res = await fetch('http://localhost:5000/thietbi');
                const data = await res.json();
                const tbody = document.querySelector('#thietBiTable tbody');
                tbody.innerHTML = '';
                data.forEach(tb => {
                    tbody.innerHTML += `<tr>
                        <td>${tb._id}</td>
                        <td>${tb.SinhVien_id}</td>
                        <td class="mac-col">${tb.MAC}</td>
                        <td>${tb.Ten_ThietBi}</td>
                        <td>${tb.TD_Them_ThietBi}</td>
                        <td><span class="badge ${tb.Is_active ? 'bg-success' : 'bg-secondary'}">${tb.Is_active ? 'Hoạt động' : 'Không hoạt động'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editTb('${tb._id}', '${tb.SinhVien_id}', '${tb.MAC}', '${tb.Ten_ThietBi}')">Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTb('${tb._id}')">Xóa</button>
                        </td>
                    </tr>`;
                });
            } catch (err) { alert('Lỗi tải thiết bị!'); }
        }

        document.getElementById('addThietBiForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editTbId').value;
            const svId = document.getElementById('svIdTB').value;
            const mac = document.getElementById('macTB').value;
            const ten = document.getElementById('tenTB').value;
            const url = editId ? `http://localhost:5000/thietbi/${editId}` : 'http://localhost:5000/thietbi';
            const method = editId ? 'PUT' : 'POST';
            await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ SinhVien_id: svId, MAC: mac, Ten_ThietBi: ten }) });
            loadThietBi(); resetTbForm();
        });

        function editTb(id, svId, mac, ten) {
            document.getElementById('editTbId').value = id;
            document.getElementById('svIdTB').value = svId;
            document.getElementById('macTB').value = mac;
            document.getElementById('tenTB').value = ten;
            document.querySelector('#addThietBiForm button[type="submit"]').textContent = 'Cập nhật';
        }

        function resetTbForm() {
            document.getElementById('addThietBiForm').reset();
            document.getElementById('editTbId').value = '';
            document.querySelector('#addThietBiForm button[type="submit"]').textContent = 'Thêm';
        }

        function deleteTb(id) {
            if (confirm('Xác nhận xóa?')) {
                fetch(`http://localhost:5000/thietbi/${id}`, { method: 'DELETE' }).then(() => loadThietBi());
            }
        }

        // ========== ĐIỂM DANH THỦ CÔNG - ĐÃ BỎ HOÀN TOÀN Is_active ==========
        async function loadSinhVienForDiemDanh() {
            try {
                const [svRes, tbRes] = await Promise.all([
                    fetch('http://localhost:5000/sinhvien'),
                    fetch('http://localhost:5000/thietbi')
                ]);
                const sinhVien = await svRes.json();
                const thietBi = await tbRes.json();

                // Tạo map: SinhVien_id → MAC (lấy thiết bị đầu tiên, KHÔNG kiểm tra Is_active)
                mapSinhVienToMac = {};
                thietBi.forEach(tb => {
                    if (tb.SinhVien_id && !mapSinhVienToMac[tb.SinhVien_id]) {
                        mapSinhVienToMac[tb.SinhVien_id] = tb.MAC;
                    }
                });

                // Điền dropdown: tất cả sinh viên có ít nhất 1 thiết bị (dù Is_active = false)
                const select = document.getElementById('svSelectDD');
                select.innerHTML = '<option value="">-- Chọn Sinh viên --</option>';
                sinhVien.forEach(sv => {
                    if (mapSinhVienToMac[sv._id]) {
                        const opt = document.createElement('option');
                        opt.value = sv._id;
                        opt.textContent = `${sv.Ten} - ${sv.MSSV}`;
                        select.appendChild(opt);
                    }
                });
            } catch (err) {
                console.error('Lỗi load điểm danh:', err);
            }
        }

        // Khi chọn sinh viên → tự động điền MAC
        document.getElementById('svSelectDD')?.addEventListener('change', function() {
            const mac = mapSinhVienToMac[this.value] || '';
            document.getElementById('macDD').value = mac;
        });

        async function loadDiemDanh() {
            try {
                const res = await fetch('http://localhost:5000/diemdanh');
                const data = await res.json();
                const tbody = document.querySelector('#diemDanhTable tbody');
                tbody.innerHTML = '';
                const today = new Date().toISOString().split('T')[0];
                data.filter(dd => dd.Ngay === today || !dd.Ngay).forEach(dd => {
                    let statusClass = dd.TrangThai.includes('Có mặt') ? 'status-co-mat' : 
                                     dd.TrangThai.includes('Vắng') ? 'status-vang' : 'status-di-tre';
                    tbody.innerHTML += `<tr>
                        <td>${dd._id}</td>
                        <td>${dd.Ten_SinhVien}</td>
                        <td class="mac-col">${dd.MAC}</td>
                        <td>${dd.Buoi}</td>
                        <td>${dd.TD_Vao ? new Date(dd.TD_Vao).toLocaleTimeString('vi-VN') : 'N/A'}</td>
                        <td>${dd.TD_Ra ? new Date(dd.TD_Ra).toLocaleTimeString('vi-VN') : 'Chưa có'}</td>
                        <td><span class="badge ${statusClass} p-2">${dd.TrangThai}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editDd('${dd._id}')">Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteDd('${dd._id}')">Xóa</button>
                        </td>
                    </tr>`;
                });
            } catch (err) { alert('Lỗi tải điểm danh!'); }
        }

        document.getElementById('diemDanhForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const mac = document.getElementById('macDD').value.toUpperCase();
            const msgDiv = document.getElementById('ddMessage');
            if (!mac) { msgDiv.innerHTML = '<div class="alert alert-warning">Vui lòng chọn sinh viên!</div>'; return; }
            try {
                const res = await fetch('http://localhost:5000/diemdanh', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ MAC: mac })
                });
                const data = await res.json();
                msgDiv.innerHTML = res.ok ?
                    `<div class="alert alert-success">${data.message} - ${data.Ten_SinhVien}: ${data.TrangThai} (${data.Buoi})</div>` :
                    `<div class="alert alert-danger">${data.message}</div>`;
                if (res.ok) { loadDiemDanh(); e.target.reset(); document.getElementById('macDD').value = ''; }
            } catch (err) { msgDiv.innerHTML = '<div class="alert alert-danger">Lỗi kết nối!</div>'; }
        });

        function editDd(id) { alert('Sửa điểm danh ID: ' + id); }
        function deleteDd(id) { if (confirm('Xóa?')) fetch(`http://localhost:5000/diemdanh/${id}`, { method: 'DELETE' }).then(() => loadDiemDanh()); }

        // ========== CÀI ĐẶT ==========
        async function loadCaiDat() {
            try {
                const res = await fetch('http://localhost:5000/caidat');
                const data = await res.json();
                const tbody = document.querySelector('#caiDatTable tbody');
                tbody.innerHTML = '';
                data.forEach(cd => {
                    tbody.innerHTML += `<tr>
                        <td>${cd._id}</td><td>${cd.Buoi}</td><td>${cd.TD_BatDau}</td><td>${cd.TD_KetThuc}</td>
                        <td>${cd.TD_Reset || 'N/A'}</td><td>${cd.Mail || 'N/A'}</td><td>${cd.TG_DiTre || 0}</td>
                        <td>${cd.TD_Setting ? new Date(cd.TD_Setting).toLocaleString('vi-VN') : 'N/A'}</td>
                        <td><span class="badge ${cd.Is_active ? 'bg-success' : 'bg-secondary'}">${cd.Is_active ? 'Hoạt động' : 'Không hoạt động'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editCd('${cd._id}', '${cd.Buoi}', '${cd.TD_BatDau}', '${cd.TD_KetThuc}', '${cd.TD_Reset || ''}', '${cd.Mail || ''}', ${cd.TG_DiTre || 0})">Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCd('${cd._id}')">Xóa</button>
                        </td>
                    </tr>`;
                });
            } catch (err) { alert('Lỗi tải cài đặt!'); }
        }

        document.getElementById('addCaiDatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editCdId').value;
            const buoi = document.getElementById('buoiCD').value;
            const tdBatDau = document.getElementById('tdBatDau').value;
            const tdKetThuc = document.getElementById('tdKetThuc').value;
            const tdReset = document.getElementById('tdReset').value;
            const mail = document.getElementById('mailCD').value;
            const tgDiTre = parseInt(document.getElementById('tgDiTre').value) || 0;
            if (tdBatDau >= tdKetThuc) { alert('Thời gian bắt đầu phải trước kết thúc!'); return; }
            const url = editId ? `http://localhost:5000/caidat/${editId}` : `http://localhost:5000/caidat`;
            const method = editId ? 'PUT' : 'POST';
            await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ Buoi: buoi, TD_BatDau: tdBatDau, TD_KetThuc: tdKetThuc, TD_Reset: tdReset, Mail: mail, TG_DiTre: tgDiTre }) });
            loadCaiDat(); resetCdForm();
        });

        function editCd(id, buoi, tdBatDau, tdKetThuc, tdReset, mail, tgDiTre) {
            document.getElementById('editCdId').value = id;
            document.getElementById('buoiCD').value = buoi;
            document.getElementById('tdBatDau').value = tdBatDau;
            document.getElementById('tdKetThuc').value = tdKetThuc;
            document.getElementById('tdReset').value = tdReset;
            document.getElementById('mailCD').value = mail;
            document.getElementById('tgDiTre').value = tgDiTre;
            document.querySelector('#addCaiDatForm button[type="submit"]').textContent = 'Cập nhật';
        }

        function resetCdForm() {
            document.getElementById('addCaiDatForm').reset();
            document.getElementById('editCdId').value = '';
            document.getElementById('tgDiTre').value = '0';
            document.querySelector('#addCaiDatForm button[type="submit"]').textContent = 'Thêm';
        }

        function deleteCd(id) {
            if (confirm('Xác nhận xóa?')) {
                fetch(`http://localhost:5000/caidat/${id}`, { method: 'DELETE' }).then(() => loadCaiDat());
            }
        }

        // ========== KHỞI TẠO ==========
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('loggedIn') === 'true') {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                showPage('dashboard');
            }
        });
    </script>
</body>
</html>